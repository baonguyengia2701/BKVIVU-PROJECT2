{% extends "common/layout.html" %}
{% load static %}
{% block content %}
    <div class="posts">
        <div class="post-list">
            <ul>
                {% for item in info %}
                <li class="item">
                    <div class="info">
                        <a href="{% url 'profilepage:profilePage' item.post.account.id%}">
                            <img src="{{item.author.avatar.url}}" alt="{{item.post.account.username}}" class="avatar">
                        </a>
                        <h3><strong>{{item.author.name}}</strong></h3>
                        <h6>Time: <strong>{{item.post.time}}</strong></h6>

                        {% if item.post.provider %}
                            Đang ở: <a href="{% url 'profilepage:profilePage' item.post.provider.account.id%}"><strong>{{item.post.provider.name}}</strong></a>
                        {% else %}
                            {% if item.post.ward and item.post.district and item.post.city%}
                                <i class="fa-solid fa-location-dot"></i>
                                    {{item.post.ward}} - {{item.post.district}} - {{item.post.city}}
                                <div style="display: flex;justify-content: center;">({{item.post.address}})
                                </div>
                            {% endif %}
                        {% endif %}
                        </p>
                    </div>
                    <h3><strong>{{item.post.title}}</strong></h3>
                    <p style="white-space: pre-line;">{{item.post.content}}</p>

                    {% if item.img|length > 0 %}
                    <div class="post-photo">
                        {% for image in item.img %}
                        <a href="{{image.img.url}}"><img src="{{image.img.url}}" alt="Post 1" class="photo"></a>
                        
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="post-actions">
                        <!-- LIKE -->
                        {% if item.userLike %}
                        <button class="_{{item.post.id}}_btnLike" value="true" onclick="likeAction(event, {{item.post.id}})" style="background-color: #f00;"> 
                        {% else %}
                        <button class="_{{item.post.id}}_btnLike" value="false" onclick="likeAction(event, {{item.post.id}})"> 
                        {% endif %}
                            <big class="_{{item.post.id}}_like">{{item.post.like}} </big> 
                            <i class="far fa-thumbs-up"></i>
                        </button>
                        <!-- Comment -->
                        <button onclick="showComment(event, {{ item.post.id }})"> 
                            <big class="_{{item.post.id}}_commentNum">{{item.post.commentNum}} </big> 
                            <i class="far fa-comment"></i> 
                        </button>
                    </div>

                    <div class="post-comment">
                        <img src="{{user.avatar.url}}" alt="" class="avatar">
                        <input type="text" placeholder="Viết bình luận ..." class="comment" id="{{item.post.id}}_comment">
                        <button class="sendCmt" onclick="insertComment(event, {{item.post.id}})"> Gửi</button>
                    </div>
                    {% comment %} ----------Comments----------- {% endcomment %}
                </li>
                {% endfor %}
            </ul>
            <!-- Hidden: click để hiển thị comment-->
            {% include "listComment.html" %}

            <!-- Hidden: click để hiển thị chi tiết bài viết khi tìm kiếm-->
            <div class="list-comment-container" id="containerPost">
                <div class="detail-post">
                  <button id="cancelButton" onclick="cancelDetailPost()" class="btn btn-secondary mt-2 float-end"><i class="fa-solid fa-xmark"></i></button>
                  <div id="showADetailPost">

                  </div>
                </div>
            </div>
        </div>

        {% comment %} -------------------------------Searching------------------------------- {% endcomment %}
        <div class="searching">
            <div class="search-container">
                <label for="search">Search: </label>
                <input type="search" id="searchPosts" name="search" placeholder="Tìm kiếm ở đây...">
                <button onclick="search_post(event)">Tìm kiếm</button>
            </div>

            <div class="result-search" id = 'resultPostSearch'>

            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        function likeAction(event, postId) {
            var btnLikeElements = document.querySelectorAll("._" + postId + "_btnLike");
            var likeNumElms = document.querySelectorAll("._" + postId + "_like");
            var liked = btnLikeElements[0].value;
            btnLikeElements.forEach(function(btnLike){
                if( btnLike.value === "false"){
                    btnLike.value = "true";
                    btnLike.style.backgroundColor = '#f00';
                }
                else{
                    btnLike.value = "false";
                    btnLike.style.backgroundColor = '#fff';
                }
            });

            var likeNum;
            if( liked === 'true'){
                likeNumElms.forEach(function(likeElm){
                    likeNum = parseInt(likeElm.innerText, 10) - 1;
                    likeElm.innerText = likeNum;
                });
            }
            else{
                likeNumElms.forEach(function(likeElm){
                    likeNum = parseInt(likeElm.innerText, 10) + 1;
                    likeElm.innerText = likeNum;
                });
            }
            
            // Gửi yêu cầu AJAX để cập nhật số lượng like trên server
            const xhr = new XMLHttpRequest();
            xhr.open("POST", `/postspage/update_likes/${postId}/`, true);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
            xhr.send(JSON.stringify({ like: likeNum}));
        }

    function insertComment(event, postId){
        var inputCmt = document.getElementById(postId + "_comment_detailPost");
        if (inputCmt){
            var contentCmd = inputCmt.value;
        }
        else{
            inputCmt = document.getElementById(postId + "_comment");
            contentCmd = inputCmt.value;
        }

        if(contentCmd.length === 0){
            alert("Hãy nhập comment");
            return;
        }

        inputCmt.value = '';

        // Gửi yêu cầu AJAX để cập nhật số lượng like trên server
        const xhr = new XMLHttpRequest();
        xhr.open("POST", `/postspage/insert_comment/${postId}/`, true);
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
        xhr.send(JSON.stringify({comment: contentCmd}));
        alert("Comment thành công rồi nhé");

        // Tăng _commentNum
        const cmtNumElms = document.querySelectorAll("._" + postId + "_commentNum");
        cmtNumElms.forEach(function(cmtNum){
            cmtNum.innerText = parseInt(cmtNum.innerText, 10) + 1
        });

        showCmt(postId)
    }
    function showComment(event, postId){
        showCmt(postId)
    }
    function showCmt(postId) {
        // Ngăn chặn hành động mặc định của nút  event.preventDefault();
        const cmtElm = document.getElementById("containerComment");
        console.log("ấn show comment rồi")
        cmtElm.style.display = "flex";
        // Gửi yêu cầu AJAX để lấy dữ liệu comment
        $.ajax({
            url: `/postspage/get_comments/${postId}/`,
            method: 'GET',
            success: function(response) {
                // Xử lý dữ liệu JSON nhận được
                var comments = response.comments;
                var containerComment = document.getElementById('allCommentOfPostId');

                // Xóa nội dung cũ trong containerComment
                containerComment.innerHTML = '';

                // Thêm các comment mới vào containerComment
                comments.forEach(function(comment) {
                    var commentHTML = `
                        <div id="comment_${comment.id}" class="d-flex flex-start mt-4">
                            <a href="/profile/${comment.authorId}">
                            <img class="rounded-circle shadow-1-strong me-3"
                            src="${comment.img}" alt="avatar" width="65"
                            height="65" />
                            </a>
                            <div class="flex-grow-1 flex-shrink-1">
                            <div>
                                <div class="d-flex justify-content-between align-items-center">
                                <p class="mb-1">
                                    ${comment.name} <span class="small"> <i class="fa-solid fa-clock"></i> ${formatTime(comment.time)}</span>
                                </p>
                                <button onclick="deleleCmt(event, ${comment.id})"><i class="fa-solid fa-xmark"></i> </button>
                                </div>
                                <p class="small mb-0"  style="white-space: pre-line;">${comment.content}</p>
                            </div>
                            </div>
                        </div>
                    `;
                    containerComment.innerHTML += commentHTML;
                });
            },
            error: function(error) {
                console.log(error);
            }
        });
    }

    function deleleCmt(event, commentId){ // xóa comment của mình thoi-----------
        // Gửi yêu cầu AJAX đến URL của Django view xử lý xóa dữ liệu
        var userChoice = window.confirm("Bạn có chắc muốn xóa bình luận không?");

        // Kiểm tra kết quả
        if (userChoice) {
        $.ajax({
            url: `/postspage/delete_comment/${commentId}/`,  // Điều chỉnh đúng đường dẫn của view xóa dữ liệu
            type: 'POST',
            data: { 'data_id': commentId },  // Truyền id của dữ liệu cần xóa
            success: function(response) {
                var containerComment = document.getElementById('comment_' + commentId);
                if(response.success === true){
                    containerComment.remove()
                    // Giảm _commentNum
                    const cmtNumElms = document.querySelectorAll("._" + response.postId + "_commentNum");
                    cmtNumElms.forEach(function(cmtNum){
                        cmtNum.innerText = parseInt(cmtNum.innerText, 10) - 1
                    });
                    alert("Xóa bình luận của bạn thành công")
                }
                else{
                    alert("Không thể xóa bình luận của người khác!!!")
                }
            },
            error: function(error) {
                console.log(error);
            }
        });
        }
    }

    function formatTime(timeString) {
        // Chuyển đổi chuỗi thời gian sang đối tượng Date

        const date = timeString.substring(0, timeString.indexOf('T'));
        const time = timeString.substring(timeString.indexOf('T') + 1, timeString.indexOf('T') + 6);
        // Định dạng lại thời gian theo ý muốn (ví dụ: dd/MM/yyyy HH:mm:ss)
        //const formattedTime = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        const formattedTime = `${date} ${time}`;
        return formattedTime;
    }
</script>

<script>// Tìm kiếm bài viết
    function search_post(event){
        var searchElement = document.getElementById("searchPosts");
        var searchKey = searchElement.value;
        $.ajax({
            url: `/postspage/search/`,
            type: 'POST',
            data: {'searchKey': searchKey},  // Truyền id của dữ liệu cần xóa
            success: function(response) {
                var resultSearchElement = document.getElementById("resultPostSearch");
                resultSearchElement.innerHTML = '';

                dataSearch = response.dataSearch;
                dataSearch.forEach(function (post){
                    var resultElement1 = `
                        <div class="result">
                            <a href="/profile/${post.authorId}">
                                <img src="${post.avatar}" alt="User 1" class="avatar">
                            </a>
                            <div class="info">
                                <h5><strong>${post.name}</strong></h5>
                                <p>Tiêu đề:
                                    <strong class="titleLink" onclick = "showDetailPosts(event, ${post.id} )">${post.title}</strong>
                                </p>
                                <div class="groupInResult">
                                    <i class="fa-solid fa-location-dot"></i>
                    `;

                    var address;
                    if( post.provider){
                        address = `
                                    <a href="/profile/${post.provider.id}"><p>${post.provider.name}</p></a>
                        `;
                    }
                    else{
                        address = `
                                    <p>${post.address}</p>
                        `;
                    }
                    var resultElement2 = `
                                </div>
                                <div class="groupInResult">
                                    <i class="fa-solid fa-thumbs-up"> ${post.like} </i>
                                    <i class="fa-solid fa-comment"> ${post.cmt} </i>
                                </div>
                            </div>
                        </div>
                    `;
                    resultSearchElement.innerHTML += (resultElement1 + address + resultElement2);

                })
            },
            error: function(error) {
                console.log(error);
            }
        });
    }

    function showDetailPosts(event, postId ){
        $.ajax({
            url: `/postspage/search/detail/${postId}/`,
            type: 'POST',
            success: function(response) {
                var containerPost = document.getElementById("containerPost");
                containerPost.style.display = 'flex';
                var showADetailPost = document.getElementById("showADetailPost");

                detailPost = response.detailPost;
                var div1 = `
                    <div class="info">
                        <a href="">
                            <img src="${detailPost.authorAvatar}" alt="" class="avatar">
                        </a>
                        <h3><strong>${detailPost.authorName}</strong></h3>
                        <h6>Time: <strong> ${formatTime(detailPost.time)}</strong></h6>
                        <p>
                        Đang ở: <a href=""><strong>${detailPost.provider}</strong></a>
                        </p>
                    </div>
                    <h3><strong>${detailPost.title}</strong></h3>
                    <p  style="white-space: pre-line;">${detailPost.content}</p>
                    <div class="post-photo">
                `;
                // vòng for hiển thị các ảnh
                detailPost.img.forEach(function(img){
                    div1 += `
                    <img src="${img}" alt="Post 1" class="photo">
                    `;
                });

                div1 += `
                    </div>

                    <div class="post-actions">
                `;
                
                if(detailPost.userLike){
                    div1 += `<button class="_${postId}_btnLike" value="true" onclick="likeAction(event, ${postId})" style="background-color: #f00;">`; 
                }
                else{
                    div1 += `<button class="_${postId}_btnLike" value="false" onclick="likeAction(event, ${postId})"> `;
                }

                div1 += `
                            <big class="_${postId}_like">${detailPost.like}</big> 
                            <i class="far fa-thumbs-up"></i>
                        </button>
                        <!-- Comment -->
                        <button onclick="showComment(event, ${postId})"> 
                            <big class="_${postId}_commentNum">${detailPost.cmt} </big> 
                            <i class="far fa-comment"></i> 
                        </button>
                    </div>

                    <div class="post-comment">
                        <img src="${detailPost.user.avatar}" alt="" class="avatar">
                        <input type="text" placeholder="Viết bình luận ..." class="comment" id="${postId}_comment_detailPost">
                        <button class="sendCmt" onclick="insertComment(event, ${postId})"> Gửi</button>
                    </div>
                `;
                showADetailPost.innerHTML = div1;
            },
            error: function(error) {
                console.log(error);
            }
        });
    }
    function cancelDetailPost(){
        var containerComment = document.getElementById('containerPost');
        containerComment.style.display = 'none'; // hoặc 'block' tùy thuộc vào yêu cầu của bạn
    }
</script>
{% endblock %}